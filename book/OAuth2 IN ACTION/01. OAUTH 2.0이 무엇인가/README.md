# 1.1 OAUTH 2.0은 무엇인가?
OAuth 2.0은 자신이 소유한 리소스에 소프트웨어 어플리케이션이 접근할 수 있도록 허용해줌으로써 접근 권한을 위임해주는 프로토콜이다.
즉 애플리케이션이 리소스 소유자에게 리소스에 대한 접근 권한을 요청하고, 요청 결과로 전달받은 토큰을 이용해 애플리케이션이 해당 리소스에 접근하는 프로토콜이다.
따라서 애플리케이션은 리소스 소유자인 것처럼 행세하지 않아도 된다.
왜냐하면 전달받은 토큰이 해당 리소스에 대한 접근 권한이 있다는 것을 나타내기 때문이다.

OAuth 토큰은 클라이언트의 접근 권한을 리소스 소유자가 허용한 범위로 제한할 수 있다.

OAuth 2.0 스펙에는 다음과 같이 정의돼 있다.

OAuth 2.0 인가 프레임워크는 리소스 소유자를 대신해 HTTP 서비스와 리소스에 대한 접근 요청 승인을 조정하거나 리소스 소유자를 대신해 서드파티 애플리케이션에게 리소스에 대한 접근을 허용해주는 방식으로 HTTP 서비스에 대한 서드파티 애플리케이션의 접근을 가능하게 해준다.

풀어 설명하면 "인가 프레인워크"로서 OAuth는 시스템의 어떤 구성 요소가 다른 시스템의 어떤 구성 요소에 대한 접근 권한을 얻을 수 있게 해주는 것이다.
특히 OAuth의 세계에서 클라이언트 애플리케이션은 리소스 소유자를 대신해 리소스 소유자의 보호된 리소스에 대한 접근 권한을 얻길 원한다.

- 리소스 소유자는 API에 대한 접근 권한을 갖고 있으며, 그것을 위임할 수 있다. 일반적으로는 리소스 소유자는 서비스 사용자고 웹 브라우저를 이용한다고 가정한다.


- 보호된 리소스는 리소스 소유자가 접근하는 구성요소다. 보호된 리소스의 형태는 다양할 수 있지만 대부분의 경우 웹 API 형태를 띤다. "리소스"의 형태는 다양할 수 있지만 대부분의 경우 웹 API 형태를 띤다.


- 클라이언트는 리소스 소유자를 대신해 보호된 리소스에 접근하는 소프트웨어 요소다. OAuth에서 클라이언트는 보호된 리소스를 구성하는 API를 이용하는 소프트웨어다.

# 자격 증명 공유
사용자의 자격 증명을 복사해 연결하고자 하는 다른 서비스에 전달하는 것이다.

문제점
- 이 방법이 가능하기 위해서는 클라이언트 애플리케이션과 보호된 리소스에 대한 사용자의 자격 증명이 동일해야 하며 그렇게 하면 자격 증명 탈취에 대한 보안성이 제한된다.
- 사용자의 비밀번호가 클라이언트에 노출된다.
- 실제 리소스 소유자인지 리소스 소유자를 가장한 클라이언트인지 구분할 수 없다.

해결법
사용자에게 물어본다.
모바일 애플리케이션이 사용자에게 자신의 자격 증명 정보를 입력하도록 요청하고 사용자가 입력한 자격 증명을 네트워크상의 백엔드 API에 직접 전달한다.
그리고 API에 대한 접근 권한을 유지하기 위해 클라이언트 애플리케이션은 사용자의 자격 증명을 저장해 필요할 때 그것을 다시 사용할 수 있다.
만약, 클라이언트가 침해되면 사용자의 계정 또한 같이 침해될 수 있기 때문이다.


# 접근 권한 위임
OAuth는 사용자가 보호된 리소스에 대한 자신의 접근 권한 일부를 클라이언트 애플리케이션에게 위임하기 위해 설계된 프로토콜이다.
이를 위해 OAuth 시스템에는 인가서버라는 구성 요소가 포함된다.

1. 보호된 리소스는 인가 서버를 신뢰하며, 인가 서버는 특정 목적의 보안 자격 증명, 즉 OAuth 액세스 토큰을 클라이언트에게 발급한다.
2. 클라이언트는 액세스 토큰을 획득하기 위해 먼저 리소스 소유자가 인가 서버에 해당 클라이언트에게 권한을 위임하도록 요청한다.
3. 그러면 일반적으로 리소스 소유자는 요청한 클라이언트를 인가할 것인지 여부를 인가 서버를 통해 선택한다.
4. 클라이언트는 접근할 수 있는 리소스 범위와 수행할 수 있는 기능을 지정해 요청할 수 있으며, 리소스 소유자는 요청된 권한을 축소할 수도 있다.
5. 일단 접근이 인가되면 클라이언트는 인가 서버에 액세스 토큰을 요청할 수 있다.
6. 발급 받은 액세스 토큰을 이용해 클라이언트는 보호된 리소스에 접근하기 위한 API를 호출할 수 있다.

위 과정동안 리소스 소유자의 자격 증명은 클라이언트에게 노출되지 않았다.
리소스 소유자가 인가 서버에 인증하는 것과는 별개로 클라이언트와 인가 서버가 통신한다.


# 권한 위임
OAuth는 자주 인가 프로토콜로 불리지만 실은 권한 위임 프로토콜이라고 할 수 있다.
일반적으로 OAuth를 통해 사용자의 일부 권한이 위임되지만, OAuth 자체가 그런 인가를 수행하는 것은 아니다.
대신 OAuth는 클라이언트가 사용자에게 사용자의 일부 권한을 위임해달라고 요청할 수 있는 수단을 제공한다.
그러면 사용자는 클라이언트의 요청을 승인하고 승인을 받은 클라이언트는 승인된 결과에 따라 원하는 작업을 수행한다.

# 사용자 주도 보안과 사용자 선택
OAuth 권한 위임 절차에는 리소스 소유자가 포함된다.
즉 중요한 보안 결정이 최종 사용자의 선택에 의해 결정된다.
이는 기존의 보안 모델과는 다르다고 할 수 있다.
OAuth에서는 의사 결정권 일부를 소프트웨어를 사용하는 사용자에게 넘겨준다.
OAuth 시스템은 주로 TOFU (Trust On First Use) 원칙을 따른다.

TOFU 모델에서는 처음에 보안 결정을 위한 어떤 전후 사정이나 설정이 존재하지 않기 때문에 보안적인 결정이 런타임에 사용자에게 요구된다.
사용자의 결정 요구를 단순하게 만들 수도 더 많은 제어를 할 수 있도록 구현하는 것도 가능하다.
어떻게 구현하든 적절한 권한을 가진 사용자라면 보안 결정을 할 수 있다.
그리고 시스템은 이후를 위해 사용자의 결정을 기억한다.
처음으로 권한 인가가 이뤄지면 이후의 처리를 위해 시스템이 사용자의 결정을 신뢰하도록 만들 수 있다.

전통적인 보안 모델에서는 기본적으로 화이트 리스트에 없는 것은 모두 블랙 리스트에 포함되었다.
하지만 TOFU 모델에 추가로 그레이 리스트를 적용할 수 있다.
그레이 리스트는 사용자 기반의 런타임 신뢰 결정을 위한 알려지지 않은 영역이다.


# OAuth 2.0 좋은 점과 나쁜 점
OAuth 2.0은 사용자의 권한 위임 결정을 캡처하고 그것을 네트워크상에 표현하는 데 매우 뛰어나다.
보안 결정 절차에는 여러 당사자가 참여하 수 있으며 특히 런타임 시에는 사용자가 보안 결정을 한다.
OAuth 2.0은 많은 유동적인 부분으로 이뤄진 프로토콜이지만, 그와 유사한 프로토콜들에 비해 훨씬 간단하고 안전하다.

OAuth 2.0의 설계에 있어서 중요한 한 가지 가정은 인가 서버나 보호된 리소스 서버보다 항상 몇 배 더 많은 클라이언트가 있을 것이라는 것이다.
하나의 인가 서버는 여러 개의 리소스 서버를 쉽게 보호할 수 있고, API를 요청하길 원하는 다양한 종류의 클라이언트가 많이 있을 수 있기 때문에 그것은 타당한 가정이라고 할 수 있다.
인가 서버의 입장에서는 클라이언트를 여러 가지 신뢰 레벨로 분류할 수 있다.
이런 아키텍처적인 판단의 결과로써 복잡성은 클라이언트에서 서버로 이동한다.
이로써 클라이언트는 단순한 소프트웨어가 될 수 있다.

반면 인가 서버와 보호된 리소스는 더 많은 복잡성과 보안을 담당한다.
클라이언트는 단지 클라이언트의 자격 증명과 토큰을 안전하게 관리하면 된다.
어떤 클라이언트가 침해된다면 그것으로 인한 피해는 해당 클라이언트의 사용자로 국한된다.
클라이언트가 침해되더라도 리소스 소유자의 자격 증명 데이터는 유출되지 않는다.
클라이언트는 애초부터 그것을 이용하지 않기 때문이다.
반면 인가 서버는 시스템상의 모든 클라이언트와 사용자에 대한 토큰을 관리해야 한다.
그러면 인가 서버가 공격의 목표가 될 수는 있지만 독립적인 개발자가 작성한 수 천개의 클라이언트를 안전하게 관리하는 것보다는 하나의 인가 서버를 안전하게 관리하는 편이 훨씬 쉬운 일이다.

OAuth 2.0의 확장성과 모듈화는 가장 큰 장점 중 하나다.
하지만 그런 유연성으로 인해 각 OAuth 구현체 간의 기본적인 호환성 문제가 발생할 수 있다.
OAuth 스펙에서는 많은 부분을 선택 사항으로 기술하고 있기 때문에 두 시스템 간에 OAuth를 구현하고자 하는 개발자들을 혼란스럽게 만들 수 있다.

# OAuth 2.0이 아닌것
OAuth는 프레임워크로 정의되기 때문에 OAuth로 간주되는 것과 그렇지 않은 것에 대한 혼란이 있어 왔다.
OAuth는 액세스 토큰을 얻기 위한 몇 가지 방법을 자세히 설명하는 핵심 OAuth 스펙에 정의된 프로토콜을 OAuth라고 간주한다.
또한 OAuth는 Bearer 토큰의 사용 방법을 기술하고 있는 부가적인 스펙의 내용도 포함한다.
즉 토큰을 얻는 방법과 토큰의 사용 방법 두 스펙 내용이 OAuth의 기본적인 부분이다.

OAuth는 HTTP 프로토콜과 독립적으로 정의되지 않는다.
왜냐하면 OAuth 2.0 Bearer 토큰은 메시지 시그니처를 제공하지 않기 때문에 HTTPS를 이용해야 한다.
따라서 민감한 비밀 정보를 전달하려면 OAuth는 TLS와 같은 안전한 전송 계층 메커니즘이 필요하다.
OAuth 토큰 전달을 위한 표준으로 SASL이 있으며 COAP를 이용하는 새로운 시도가 이뤄지고 있다.
그리고 미래에는 TLS를 이용하지 않고도 OAuth를 이용하기 위한 노력이 이뤄질 것이다.
하지만 그런 경우에도 HTTPS 트랜잭션과 다른 프로토콜 및 시스템 간의 명확한 매핑이 필요하다.

OAuth는 인증 프로토콜이 아니다.
OAuth 트랜잭션 자체만으로 사용자가 누구인지 알 수 없다.
OAuth는 본질적으로 다양한 서비스와 기능을 가능하게 하기 위해 사용될 수 있는 재료라고 할 수 있다.
또한 OAuth는 여러 곳에서 인증을 사용한다.
특히, 인가 서버가 리소스 소유자와 클라이언트 소프트웨어를 인증할 때 사용한다.
그렇다고 해서 그런 내재된 인증 자체만으로 OAuth가 인증 프로토콜이 되지는 않는다.

OAuth는 기본적으로 사용자가 소프트웨어 권한을 위임하는 것이지만 사용자 간의 권한 위임 메커니즘은 정의하지 않는다.
OAuth에서 리소스 소유자는 클라이언트를 통제하는 사람이라고 가정한다.
리소스 소유자가 다른 사람을 인가할 수 있게 하려면 OAuth 만으로는 힘들다.
그런 형태의 권한 위임은 일반적이지 않으며 UMA 프로토콜은 OAuth를 이용해 사용자 간의 권한 위임이 가능한 시스템을 만든다.

OAuth는 인가 절차 메커니즘을 정의하지 않는다.
OAuth는 권한 위임이 이뤄졌다는 사실을 전달하기 위한 방법을 제공하지만, 권한 인가 자체의 내용을 정의하지는 않는다.
대신 토큰과 그것의 범위 같은 OAuth의 구성 요소를 이용해 허용 가능한 작업이 어떤 것인지 서비스 API로 정의한다.

OAuth는 토큰의 포맷을 정의하지 않는다.
실제로 OAuth 프로토콜은 토큰의 내용이 클라이언트 애플리케이션에게 완전히 불투명하다고 명확히 기술하고 있다.
이는 클라이언트 애플리케이션이 토큰을 구문 분석하고 처리해야 하는 WS-, SAML, 커버로스와 같은 이전의 프로토콜과 다른 점이다.
하지만 토큰을 발급하는 인가 서버와 토큰을 받아들이는 보호된 리소스는 여전히 그것을 이해할 필요가 있다.
그론 필요성으로 인해 JWT와 Token Introsepction 프로토콜이 개발로 이어졌다.
즉 토큰 자체는 여전히 클라이언트에게 불투명하지만 상대방은 그것의 포맷을 이해할 수 있는 것이다.

OAuth 2.0은 OAuth 1.0 과 달리 암호화 방법을 정의하지 않는다.
OAuth 2.0 프로토콜은 OAuth에서 사용되는 새로운 암호화 메커니즘을 정의하지 않고 OAuth 외부에서 일반적인 목적으로 사용되는 암호화 메커니즘을 허용하도록 하고 있다.
그렇게 암호화 메커니즘을 의도적으로 누락시킴으로써 OAuth가 아닌 곳에서도 일반적인 목적의 암호화 메커니즘으로 사용할 수 있는 JOSE와 같은 암호 메커니즘 스펙이 만들어져 왔다.

OAuth 2.0은 단일 프로토콜이 아니다.
앞에서 언급했듯이 OAuth 스펙은 사용 방법이 각기 다른 여러 가지 정의와 흐름으로 나뉜다.
OAuth 2.0은 다양한 경우를 위한 보안 아키텍처 설계에 사용될 수 있기 때문에 보안 프로토콜 생성기로 묘사되기도 한다.
앞 절에서도 논의했듯이 그런 다양한 시스템은 서로 호환돼야 할 필요가 없다.

OAuth는 모든 보안적인 요소를 해결하기 위한 일체형 프로토콜이라기보다 한 부분에 초점을 맞추고 나머지 부분은 더 적합한 다른 구성 요소가 담당할 수 있는 여지를 남겨둔 프로토콜이다.
OAuth가 제공하지 않는 것이 많을지라도 다른 툴들이 보다 종합적인 보안 아키텍처를 설계를 할 수 있는 견고한 초석을 제공한다.

# 요약
OAuth는 널리 사용되는 보안 표준으로서 친숙한 웹 API를 이용해 보호된 리소스에 안전하게 접근할 수 있게 해준다.
- OAuth는 토큰을 어떻게 획득하고 그것을 어떻게 사용하는지에 대한 스펙이다.
- OAuth는 인가 접근 시스템을 위한 권한 위임 프로토콜이다.
- OAuth는 보다 안전하고 유용한 권한 위임 프로토콜로 비밀번호 공유 패턴을 대체한다.
- OAuth는 작은 문제들을 잘 해결하는 것에 초점을 맞추고 있으며, 이를 통해 보다 큰 보안 시스템에서 적합한 구성 요소가 될 수 있다.
